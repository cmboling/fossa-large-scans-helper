name: Full EPEL SRPM Scan + FOSSA Analyze

on:
  workflow_dispatch:

env:
  FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}

jobs:
  scan-srpms:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rpm:
          - csmock-3.8.1-1.el8.src.rpm
          - cros-guest-tools-126-3.el8.src.rpm
          - catimg-2.7.0-3.el8.src.rpm
          - CGSI-gSOAP-1.3.12-1.el8.src.rpm
          - cxxopts-3.1.1-1.el8.src.rpm
          - cotila-1.2.1-2.el8.src.rpm
          - clusterssh-4.18-1.el8.src.rpm
          - colord-kde-0.5.0-16.el8.src.rpm
          - copr-cli-2.1-1.el8.src.rpm
          - c-icap-modules-0.5.7-5.20250117git36a6688.el8.src.rpm
          - calamaris-2.99.4.8-1.el8.src.rpm
          - cacti-spine-1.2.30-1.el8.src.rpm
          - castxml-0.6.11-1.el8.src.rpm
          - cronolog-1.6.2-34.el8.src.rpm
          - ccze-0.2.1-27.el8.src.rpm
          - c4project-0^20230525gita1f9d73-3.el8.src.rpm
          - cpuid-20230614-3.el8.src.rpm
          - cpp-hocon-0.2.1-2.el8.src.rpm
          - canl-c-3.0.0-8.el8.src.rpm

    name: Scan ${{ matrix.rpm }}
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm2cpio cpio curl zip unzip

      - name: Download RPM
        run: |
          mkdir -p srpms
          cd srpms
          curl -O "https://dl.fedoraproject.org/pub/epel/8/Everything/SRPMS/Packages/c/${{ matrix.rpm }}"

      - name: Skip if over 1MB
        id: check
        run: |
          cd srpms
          size_bytes=$(stat -c%s "${{ matrix.rpm }}")
          if [ "$size_bytes" -gt $((1 * 1024 * 1024)) ]; then
            echo "has_results=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "has_results=true" >> $GITHUB_OUTPUT
          fi

      - name: Extract and generate fossa-deps with 200MB split logic
        if: steps.check.outputs.has_results == 'true'
        run: |
          mkdir -p vendor
          rpm="${{ matrix.rpm }}"
          rpm_basename=$(basename "$rpm" .src.rpm)
          extract_dir="vendor/${rpm_basename}"
          mkdir -p "$extract_dir"

          curl -O "https://dl.fedoraproject.org/pub/epel/8/Everything/SRPMS/Packages/c/$rpm"
          rpm2cpio "$rpm" | cpio -idmv
          find . -mindepth 1 -maxdepth 1 ! -name vendor -exec mv {} "$extract_dir"/ \;

          mkdir -p fossa-partial
          deps_file="fossa-partial/deps-${rpm_basename}.yml"
          touch "$deps_file"

          version=$(echo "$rpm_basename" | sed -E 's/^[^-]+-//')
          name=$(echo "$rpm_basename" | sed -E "s/-$version$//")
          timestamp=$(date +%s)
          i=1
          max_size=$((200 * 1024 * 1024))

          find "$extract_dir" -type d | while read dir; do
            dir_size=$(du -sb "$dir" | cut -f1)
            if [ "$dir_size" -le "$max_size" ]; then
              rel_path=$(echo "$dir" | sed 's|^vendor/||')
              frag_name="${name}-fragment-${i}-${timestamp}"
              echo "- name: $frag_name" >> "$deps_file"
              echo "  path: vendor/$rel_path" >> "$deps_file"
              echo "  version: $version" >> "$deps_file"
              i=$((i + 1))
            else
              chunk_dir="vendor/${rpm_basename}-fragment-${i}-${timestamp}"
              mkdir -p "$chunk_dir"
              chunk_size=0
              j=1
              find "$dir" -type f | while read file; do
                file_size=$(stat -c%s "$file")
                if [ $((chunk_size + file_size)) -gt "$max_size" ]; then
                  frag_name="${name}-fragment-${i}-${timestamp}"
                  echo "- name: $frag_name" >> "$deps_file"
                  echo "  path: $chunk_dir" >> "$deps_file"
                  echo "  version: $version" >> "$deps_file"
                  i=$((i + 1))
                  j=$((j + 1))
                  chunk_dir="vendor/${rpm_basename}-fragment-${i}-${timestamp}"
                  mkdir -p "$chunk_dir"
                  chunk_size=0
                fi
                rel_subpath="${file#$dir/}"
                mkdir -p "$chunk_dir/$(dirname "$rel_subpath")"
                cp "$file" "$chunk_dir/$rel_subpath"
                chunk_size=$((chunk_size + file_size))
              done
              if [ "$chunk_size" -gt 0 ]; then
                frag_name="${name}-fragment-${i}-${timestamp}"
                echo "- name: $frag_name" >> "$deps_file"
                echo "  path: $chunk_dir" >> "$deps_file"
                echo "  version: $version" >> "$deps_file"
                i=$((i + 1))
              fi
            fi
          done

      - name: Zip deps fragment
        if: steps.check.outputs.has_results == 'true'
        run: |
          zip -j fossa-deps-fragment-${{ matrix.rpm }}.zip fossa-partial/*.yml

      - name: Upload zipped artifact
        if: steps.check.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: fossa-fragment-${{ matrix.rpm }}
          path: fossa-deps-fragment-${{ matrix.rpm }}.zip

      - name: Upload vendor directory
        if: steps.check.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vendor-${{ matrix.rpm }}
          path: vendor

  merge-and-analyze:
    needs: scan-srpms
    runs-on: ubuntu-latest
    name: Merge and Analyze

    steps:
      - name: Download all fossa-deps fragments
        uses: actions/download-artifact@v4
        with:
          path: fragments

      - name: Extract deps fragments
        run: |
          mkdir merged-deps
          for zip in fragments/**/fossa-deps-fragment-*.zip; do
            unzip -o "$zip" -d merged-deps
          done

      - name: Download vendor directories
        uses: actions/download-artifact@v4
        with:
          path: vendor-sources

      - name: Merge vendor trees
        run: |
          mkdir -p vendor
          find vendor-sources -mindepth 2 -type f,d | while read path; do
            rel="vendor/$(basename $(dirname "$path"))"
            mkdir -p "$rel"
            cp -r "$path" "$rel/" || true
          done

      - name: Build fossa-deps.yml
        run: |
          echo "vendored-dependencies:" > fossa-deps.yml
          for file in merged-deps/*.yml; do
            cat "$file" | sed 's/^/  /' >> fossa-deps.yml
          done
          echo "--- Final fossa-deps.yml ---"
          cat fossa-deps.yml

      - name: Install FOSSA CLI
        run: |
          curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash
          fossa --version
          ls -l
          tree

      - name: Run FOSSA Analyze
        run: |
          fossa analyze --debug

      - name: Upload fossa-deps.yml
        uses: actions/upload-artifact@v4
        with:
          name: final-fossa-deps
          path: fossa-deps.yml
